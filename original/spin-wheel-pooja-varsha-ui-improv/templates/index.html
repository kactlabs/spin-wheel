<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Titan+One&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@200&family=Prompt:wght@200&family=Titan+One&display=swap" rel="stylesheet">
    <title>Wheel</title>
    <style>
        text {
            font-family: 'Prompt', sans-serif;
            font-weight: bold;
            font-size: 25px;
            pointer-events: none;
            fill: white; /* Ensure text color is white */
        }

        #chart {
            position: relative;
            width: 500px;
            height: 500px;
            border-radius: 50%;
            border: 10px solid #fff;
            overflow: hidden;
            transition: all ease 5s;
            z-index: 1;
            display: flex; /* Use flexbox to center content */
            justify-content: center;
            align-items: center;
        }

        /* Adjust form positioning */
        form {
            /* Removed absolute positioning and transform to allow flexbox to position */
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            margin-right: 50px; /* Add some space between form and wheel */
        }

        /* Ensure the spin button is correctly positioned relative to its container */
        .spin-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 75px;
            height: 75px;
            border-radius: 50%;
            border: 4px solid #fff;
            background-color: #808bec;
            color: #000;
            box-shadow: 0 5px 20px #000;
            font-weight: bold;
            font-size: 22px;
            cursor: pointer;
            z-index: 10;
        }
        .spin-button:active {
            width: 70px;
            height: 70px;
            font-size: 20px;
        }

        #chart:after {
            position: absolute;
            content: '';
            width: 32px;
            height: 32px;
            background: url('/static/arrow-left.png') no-repeat; /* Updated path for Flask static files */
            background-size: 32px;
            right: -30px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
        }

        #chart.animate:after {
            animation: animateArrow 0.7s ease infinite;
        }

        @keyframes animateArrow {
            50% {
                right: -40px;
            }
        }

        body {
            margin: 0;
            padding: 0;
            background: rgb(241, 241, 241);
            height: 100vh; /* Use vh for full viewport height */
            width: 100vw; /* Use vw for full viewport width */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #main-content-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        #question {
            position: absolute;
            top: 50%;
            left: calc(50% + 300px); /* Position to the right of the wheel, adjust 300px as needed */
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 11;
            pointer-events: none;
            width: 200px; /* Give it a width to prevent text overflow */
        }

        #question h1 {
            font-size: 50px;
            font-weight: bold;
            font-family: 'Poppins', sans-serif;
            color: #333;
            margin: 0;
            padding: 0;
        }

        form {
            /* Removed absolute positioning and transform to allow flexbox to position */
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            margin-right: 50px; /* Add some space between form and wheel */
        }
        form label {
            font-family: 'Poppins', sans-serif;
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        form input[type="text"] {
            width: 300px;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        form input[type="submit"] {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        form input[type="submit"]:hover {
            background-color: #0056b3;
        }
    </style>
</head>

<body>
    <div id="main-content-wrapper">
        <form action="/add_names" method="post" enctype="application/x-www-form-urlencoded">
            <label for="names">Add Names (comma-separated):</label><br>
            <input type="text" id="names" name="names"><br><br>
            <input type="submit" value="Add Names">
        </form>

        <div id="chart"></div>
    </div>

    <div id="question">
        <h1></h1>
    </div>

    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/2.0.2/anime.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <script>
        var padding = {
                top: 20,
                right: 40,
                bottom: 0,
                left: 10
            },
            w = 500 - padding.left - padding.right,
            h = 500 - padding.top - padding.bottom,
            r = Math.min(w, h) / 2,
            rotation = 0,
            oldrotation = 0; // Removed picked and oldpick as they are no longer used
        
        var data = JSON.parse('{{values|tojson}}');

        var svg = d3.select('#chart')
            .append("svg")
            .data([data])
            .attr("width", w + padding.left + padding.right)
            .attr("height", h + padding.top + padding.bottom);
        var container = svg.append("g")
            .attr("class", "chartholder")
            .attr("transform", "translate(" + (w / 2 + padding.left) + "," + (h / 2 + padding.top) + ")");
        var vis = container
            .append("g");

        var pie = d3.layout.pie().sort(null).value(function (d) {
            return 1;
        });
        var arc = d3.svg.arc().outerRadius(r);
        var arcs = vis.selectAll("g.slice")
            .data(pie(data)) // Initial data binding
            .enter()
            .append("g")
            .attr("class", "slice");

        arcs.append("path")
            .attr("fill", function (d, i) {
                return data[i].color;
            })
            .attr("d", function (d) {
                return arc(d);
            });
        arcs.append("text").attr("transform", function (d) {
                d.innerRadius = 0;
                d.outerRadius = r;
                d.angle = (d.startAngle + d.endAngle) / 2;
                // Adjust rotation and translation for text to appear correctly
                // Rotate by (angle - 90) for horizontal text, then translate outwards
                return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")translate(" + (d.outerRadius - 80) + ")";
            })
            .attr("text-anchor", "middle")
            .style("fill", "white")
            .style("font-size", "18px") /* Increased font size for better visibility */
            .text(function (d, i) {
                return data[i].label;
            });
        
        container.append("circle")
            .attr("cx", 0)
            .attr("cy", 0)
            .attr("r", 60)
            .style("fill", "#808bec") /* Blue background */
            .style("stroke", "#fff") /* White border */
            .style("stroke-width", "4px") /* 4px border */
            .style("cursor", "pointer")
            .on("click", spin);

        container.append("text")
            .attr("x", 0)
            .attr("y", 15)
            .attr("text-anchor", "middle")
            .text("SPIN")
            .style("font-weight", "bold")
            .style("font-size", "30px")
            .style("font-family", "'Poppins', sans-serif")
            .style("fill", "#000") /* Black text color */
            .on("click", spin);


        function spin(d) {
            d3.selectAll(".spin-button").on("click", null); // Disable spin button during spin

            var availableData = data.filter(function(d) { return !d.picked; });

            if (availableData.length === 0) {
                d3.select("#question h1").text("No more names!");
                d3.selectAll(".spin-button").on("click", null);
                return;
            }

            var ps = 360 / availableData.length,
                rng = Math.floor((Math.random() * 1440) + 360);

            rotation = (Math.round(rng / ps) * ps);

            var pickedIndexInAvailable = Math.round(availableData.length - (rotation % 360) / ps);
            pickedIndexInAvailable = pickedIndexInAvailable >= availableData.length ? (pickedIndexInAvailable % availableData.length) : pickedIndexInAvailable;
            
            var pickedItem = availableData[pickedIndexInAvailable];
            var originalIndex = data.indexOf(pickedItem); // Find the original index of the picked item

            rotation += 90 - Math.round(ps / 2);
            vis.transition()
                .duration(3000)
                .attrTween("transform", rotTween)
                .each("end", function () {
                    // Pop up the selected name
                    d3.select("#question h1")
                        .text(pickedItem.question);
                    oldrotation = rotation;
                    
                    // Mark the picked item as 'picked' and set its color to black
                    data[originalIndex].picked = true;
                    data[originalIndex].color = "#111"; // Set to black

                    // Re-render the wheel with updated data
                    container.selectAll("g.slice").remove(); // Remove existing slices
                    var pie = d3.layout.pie().sort(null).value(function (d) {
                        return 1;
                    });
                    var arcs = vis.selectAll("g.slice")
                        .data(pie(data)) // Use updated data
                        .enter()
                        .append("g")
                        .attr("class", "slice");

                    arcs.append("path")
                        .attr("fill", function (d, i) {
                            return data[i].color;
                        })
                        .attr("d", function (d) {
                            return arc(d);
                        });
                    arcs.append("text").attr("transform", function (d) {
                            d.innerRadius = 0;
                            d.outerRadius = r;
                            d.angle = (d.startAngle + d.endAngle) / 2;
                            return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")translate(" + (d.outerRadius - 80) + ")";
                        })
                        .attr("text-anchor", "middle")
                        .style("fill", function(d, i) { return data[i].color === "#111" ? "black" : "white"; }) /* Set text color based on segment color */
                        .style("font-size", "18px")
                        .text(function (d, i) {
                            return data[i].label;
                        });

                    d3.selectAll(".spin-button").on("click", spin); // Re-enable spin button
                });
        }

        function rotTween(to) {
            var i = d3.interpolate(oldrotation % 360, rotation);
            return function (t) {
                return "rotate(" + i(t) + ")";
            };
        }

        // Removed custom JavaScript for form submission to rely on default browser behavior
    </script>
</body>

</html>
